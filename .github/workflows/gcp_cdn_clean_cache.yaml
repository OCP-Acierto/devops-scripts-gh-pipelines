name: Clean Cache GCP CDN
on:
  workflow_call:
    inputs:
      gcp_project:
        default: ''
        required: true
        type: string
      gcp_cdn_lb:
        default: ''
        required: true
        type: string
    secrets:
      gcp_cdn_cache_invalidate_prod:
        required: false
      gcp_cdn_cache_invalidate_preprod:
        required: false
env:
  GCP_CACHE_CRED_PRE: ${{ secrets.gcp_cdn_cache_invalidate_preprod }}
  GCP_CACHE_CRED_PROD: ${{ secrets.gcp_cdn_cache_invalidate_prod }}
  GCP_PROJECT: ${{ inputs.gcp_project }}
  GCP_CDN_LB: ${{ inputs.gcp_cdn_lb }}
jobs:
  job:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - name: Configure GCP Credentials PROD
        uses: google-github-actions/auth@v0
        if: ${{ env.GCP_CACHE_CRED_PROD != '' }}
        with:
          credentials_json: ${{ secrets.gcp_cdn_cache_invalidate_prod }}
      
      - name: Configure GCP Credentials PREPROD
        uses: google-github-actions/auth@v0
        if: ${{ env.GCP_CACHE_CRED_PREPROD != '' }}
        with:
          credentials_json: ${{ secrets.gcp_cdn_cache_invalidate_preprod }}

      - name: Clean cache GCP CDN
        run: |
          echo "[INFO] Invalidate cache CDN GCP"
          gcloud compute url-maps invalidate-cdn-cache \
            "cdn" \
            --host "${GCP_CDN_LB}" \
            --path "/*" \
            --project "${GCP_PROJECT}"